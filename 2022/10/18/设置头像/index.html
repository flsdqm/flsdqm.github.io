<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>设置头像 | Dr.粉蓝色の浅梦</title><script>var config = {"hostname":"http://example.com","root":"/","preload":false,"path":""}</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.1.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><main><header><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem search-header"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></li><li class="navItem"><a href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>设置头像</h1><div id="post-info"><span>First Post:<span class="control"><time datetime="2022-10-18T14:32:04.000Z" id="date"> 2022-10-18</time></span></span><br><span>Last Update:<span class="control"><time datetime="2022-10-18T14:35:14.020Z" id="updated"> 2022-10-18</time></span></span></div></div><hr><div id="post-content"><h1 id="设置头像（学废了）"><a href="#设置头像（学废了）" class="headerlink" title="设置头像（学废了）"></a>设置头像（学废了）</h1><p>​                                                                                                                                                                                                            <em>By flsdqm</em></p>
<h2 id="一、权限"><a href="#一、权限" class="headerlink" title="一、权限"></a>一、权限</h2><h3 id="1-动态权限"><a href="#1-动态权限" class="headerlink" title="1.动态权限"></a>1.动态权限</h3><p>动态权限是在Android6.0及以上的按需申请的权限方式。用户在用到该功能的时候，应用会通过代码申请，会弹出如下内容：</p>
<img src="https://s3.bmp.ovh/imgs/2022/04/04/dfc03a3cc465bae0.jpg" style="zoom: 25%;" />

<p>用户可以选择拒绝，不会影响到别的功能的使用。这是优化过的方式。</p>
<h3 id="2-静态权限"><a href="#2-静态权限" class="headerlink" title="2.静态权限"></a>2.静态权限</h3><p>这是旧的权限申请方式，大概已经没什么手机还在用了。它是将权限在AndroidManifest中全列出来，安装的时候就需要用户全盘接受，否则就无法安装。</p>
<p>总之，要在AndroidManifest中先加上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;uses-permission android:name=<span class="hljs-string">&quot;android.permission.CAMERA&quot;</span> /&gt;<br>&lt;uses-permission android:name=<span class="hljs-string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;<br></code></pre></td></tr></table></figure>

<h2 id="二、从相机获取图片"><a href="#二、从相机获取图片" class="headerlink" title="二、从相机获取图片"></a>二、从相机获取图片</h2><p>先判断是否有相机权限，如果有权限则执行拍照，这里就是动态权限的应用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(<span class="hljs-built_in">this</span>, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED)<br></code></pre></td></tr></table></figure>

<p>如果没有权限，则去申请权限。中间的 new String[]{Manifest.permission.CAMERA}是一个数组，其实它可以传递多个权限。这里仅申请相机权限，后面的1是请求码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ActivityCompat.requestPermissions(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;Manifest.permission.CAMERA&#125;, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<p>全方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">takePhoto</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(<span class="hljs-built_in">this</span>, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED) &#123;<br>        <span class="hljs-comment">// 执行拍照</span><br>        doTake();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 申请权限</span><br>        ActivityCompat.requestPermissions(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;Manifest.permission.CAMERA&#125;, <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接着需要覆写方法onRequestPermissionsResult，用来接收权限请求的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRequestPermissionsResult</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCode, <span class="hljs-meta">@NonNull</span> String[] permissions, <span class="hljs-meta">@NonNull</span> <span class="hljs-type">int</span>[] grantResults)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);<br>    <span class="hljs-keyword">if</span> (requestCode == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (grantResults.length &gt; <span class="hljs-number">0</span> &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;<br>            doTake();<span class="hljs-comment">//去往拍照功能</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;你没有获得摄像头权限~&quot;</span>, Toast.LENGTH_SHORT).show();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>其中String[] permissions，int[] grantResults都是数组，通过的结果就是存储在grantResults中的，之前说前者是一个数组，可以传多个权限，这里两个数组它们的内容是一一对应的。</p>
<p>先判断requestCode是否为之前申请时设定的1，如果是那么就继续判断grantResults，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">grantResults.length &gt; <span class="hljs-number">0</span> &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED<br></code></pre></td></tr></table></figure>

<p>这里grantResults.length &gt; 0是为了保证grantResults[0]取值时不会为空。</p>
<p>之后取用系统相机功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>intent.setAction(<span class="hljs-string">&quot;android.media.action.IMAGE_CAPTURE&quot;</span>);<br>intent.putExtra(MediaStore.EXTRA_OUTPUT, imageUri);<br></code></pre></td></tr></table></figure>

<p>这里用intent调用，再用intent的传值方法给一个键值对，键就是MediaStore.EXTRA_OUTPUT，输出到的位置用Uri来传递，Uri就是资源的位置。在android11以后的强制分区存储，外部资源无法访问，需要添加一个输出保存位置，然后进行取值操作。如果是Android10时分区存储要求没那么严格，可以在AndroidManifest中加上</p>
<p>android:requestLegacyExternalStorage&#x3D;”true”   来应对。（不添加会在imagepath处报为空）</p>
<p>最后再</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">startActivityForResult(intent, REQUEST_CODE_TAKE);<br></code></pre></td></tr></table></figure>

<p>（现在startActivityForResult()方法已经被谷歌标记为了Deprecated，方法不推荐使用了，谷歌推荐使用Activity Results API。）</p>
<p>此时，虽然有了路径，但文件还不存在。因此，要在前面加上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">File</span> <span class="hljs-variable">imageTemp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getExternalCacheDir(), <span class="hljs-string">&quot;imageOut.jpeg&quot;</span>);<br><span class="hljs-keyword">if</span> (imageTemp.exists()) &#123;<br>            imageTemp.delete();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            imageTemp.createNewFile();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>getExternalCacheDir()是路径，”imageOut.jpeg”是图片文件名。</p>
<p>并且，如果本身存在文件要删除，再保存新的文件。</p>
<p>接着，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">if (Build.VERSION.SDK_INT &gt; 24) &#123;<br>    // contentProvider<br>    imageUri = FileProvider.getUriForFile(this, &quot;com.bignerdranch.android.blackboard.fileprovider&quot;, imageTemp);<br>&#125; else &#123;<br>    imageUri = Uri.fromFile(imageTemp);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在安卓API24之前是可以用底下的方法简单粗暴获取uri的，但在api24后考虑到会有安全问题，原本方法就不可用了。</p>
<p>这里新方法中用到了contentProvider，这个东西是用来将自己的数据分享出去的，且能保证分享出的数据不滥用。此处是从文件提供者那里获取图片文件。getUriForFile中间的authority需要定义这个contentProvider。</p>
<p>在AndroidManifest中的application中加入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;provider<br>    android:authorities=<span class="hljs-string">&quot;com.bignerdranch.android.blackboard.fileprovider&quot;</span><span class="hljs-comment">//一般是包名+provider</span><br>    android:name=<span class="hljs-string">&quot;androidx.core.content.FileProvider&quot;</span><span class="hljs-comment">//名字</span><br>    android:exported=<span class="hljs-string">&quot;false&quot;</span><br>    android:grantUriPermissions=<span class="hljs-string">&quot;true&quot;</span><br>    &gt;<br>    &lt;meta-data<br>        android:name=<span class="hljs-string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span><span class="hljs-comment">//提供文件路径</span><br>        android:resource=<span class="hljs-string">&quot;@xml/files&quot;</span> /&gt;<span class="hljs-comment">//resource对应路径</span><br>&lt;/provider&gt;<br></code></pre></td></tr></table></figure>

<p>@xml&#x2F;files需要创建，里面是外部的路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;<br>&lt;paths xmlns:android=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;<br>    &lt;external-path<br>        name=<span class="hljs-string">&quot;image_path&quot;</span><br>        path=<span class="hljs-string">&quot;/&quot;</span>/&gt;<br>&lt;/paths&gt;<br></code></pre></td></tr></table></figure>

<p>接下来覆写onActivityResult</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityResult</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> resultCode, <span class="hljs-meta">@Nullable</span> Intent data)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onActivityResult(requestCode, resultCode, data);<br>    <span class="hljs-keyword">if</span> (requestCode == REQUEST_CODE_TAKE) &#123;<br>        <span class="hljs-keyword">if</span> (resultCode == RESULT_OK) &#123;<br>            <span class="hljs-comment">// 获取拍摄的照片</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> getContentResolver().openInputStream(imageUri);<br>                <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> BitmapFactory.decodeStream(inputStream);<br>                ivAvatar.setImageBitmap(bitmap);<span class="hljs-comment">// 显示图片</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">imageToBase64</span> <span class="hljs-operator">=</span> ImageUtil.imageToBase64(bitmap);<br>                imageBase64 = imageToBase64;<br>            &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中getContentResolver是contentProvider中的内容的处理者，我们根据处理者来获取数据。开一个输入流来读取uri，我们得到的这个01组成的流就是图片。这段流可以通过BitmapFactory.decodeStream解析出来，赋给bitmap。</p>
<p>我们需要将图片转成base64字符串才能在sharedpreferences中保存。</p>
<p>写一个工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageUtil</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">imageToBase64</span><span class="hljs-params">(Bitmap bitmap)</span> &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="hljs-number">100</span>, byteArrayOutputStream);<br>        <span class="hljs-type">byte</span>[] buffer = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">baseStr</span> <span class="hljs-operator">=</span> Base64.encodeToString(buffer, Base64.DEFAULT);<br>        <span class="hljs-keyword">return</span> baseStr;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">base64ToImage</span><span class="hljs-params">(String bitmap64)</span> &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.decode(bitmap64, Base64.DEFAULT);<br>        <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> BitmapFactory.decodeByteArray(bytes, <span class="hljs-number">0</span>, bytes.length);<br>        <span class="hljs-keyword">return</span> bitmap;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>imageToBase64先将图片压缩，之后变为输出流。在一个byte类数组中接收输出流。最后用encodeToString这样的一种编码方式将buffer通过默认方法Base64.DEFAULT存入String。</p>
<p>base64ToImage就比较好理解了，它直接用decode解析，再转化为bitmap。 0, bytes.length两个参数表示从头到尾全部的内容。</p>
<p>接下来在SharedPreferences中保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">spfRecord</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">&quot;spfRecord&quot;</span>, MODE_PRIVATE);<br>SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">edit</span> <span class="hljs-operator">=</span> spfRecord.edit();<br>edit.putString(<span class="hljs-string">&quot;image_64&quot;</span>, imageBase64);<br>edit.apply();<br></code></pre></td></tr></table></figure>

<p>同时也记得初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">spfRecord</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">&quot;spfRecord&quot;</span>, MODE_PRIVATE);<br><span class="hljs-type">String</span> <span class="hljs-variable">image64</span> <span class="hljs-operator">=</span> spfRecord.getString(<span class="hljs-string">&quot;image_64&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>ivAvatar.setImageBitmap(ImageUtil.base64ToImage(image64));<br></code></pre></td></tr></table></figure>

<h2 id="三、从相册获取图片"><a href="#三、从相册获取图片" class="headerlink" title="三、从相册获取图片"></a>三、从相册获取图片</h2><p>先新建方法，与相机的takePhoto方法类似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choosePhoto</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(<span class="hljs-built_in">this</span>, Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED) &#123;<br>        <span class="hljs-comment">// 打开相册</span><br>        openAlbum();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 申请权限</span><br>        ActivityCompat.requestPermissions(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;, <span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>读的权限可以省略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openAlbum</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">&quot;android.intent.action.GET_CONTENT&quot;</span>);<br>    intent.setType(<span class="hljs-string">&quot;image/*&quot;</span>);<br>    startActivityForResult(intent, REQUEST_CODE_CHOOSE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此处还是用intent来给一个action，接着给intent一个type去找图片类型。传入请求码 </p>
<p>public static final int REQUEST_CODE_CHOOSE &#x3D; 0;</p>
<p>于是onRequestPermissionsResult加上一个else if变为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) &#123;<br>    super.onRequestPermissionsResult(requestCode, permissions, grantResults);<br>    if (requestCode == 1) &#123;<br>        if (grantResults.length &gt; 0 &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) &#123;<br>            doTake();<br>        &#125; else &#123;<br>            Toast.makeText(this, &quot;你没有获得摄像头权限~&quot;, Toast.LENGTH_SHORT).show();<br>        &#125;<br>    &#125; else if (requestCode == 0) &#123;<br>        if (grantResults.length &gt; 0 &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) &#123;<br>            openAlbum();<br>        &#125; else &#123;<br>            Toast.makeText(this, &quot;你没有获得访问相册的权限~&quot;, Toast.LENGTH_SHORT).show();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>同时，onActivityResult也要进行添加。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">@Override<br>protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) &#123;<br>    super.onActivityResult(requestCode, resultCode, data);<br>    if (requestCode == REQUEST_CODE_TAKE) &#123;<br>        if (resultCode == RESULT_OK) &#123;<br>            // 获取拍摄的照片<br>            try &#123;<br>                InputStream inputStream = getContentResolver().openInputStream(imageUri);<br>                Bitmap bitmap = BitmapFactory.decodeStream(inputStream);<br>                ivAvatar.setImageBitmap(bitmap);<br>                String imageToBase64 = ImageUtil.imageToBase64(bitmap);<br>                imageBase64 = imageToBase64;<br>            &#125; catch (FileNotFoundException e) &#123;<br><br>            &#125;<br>        &#125;<br>    &#125; else if (requestCode == REQUEST_CODE_CHOOSE) &#123;<br><br>        if (Build.VERSION.SDK_INT &lt; 19) &#123;<br>            handleImageBeforeApi19(data);<br>        &#125; else &#123;<br>            handleImageOnApi19(data);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>拿的时候要区分api19前后。在19前</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">private void handleImageBeforeApi19(Intent data) &#123;<br>    Uri uri = data.getData();<br>    String imagePath = getImagePath(uri, null);<br>    displayImage(imagePath);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先从data获取uri，接着前往getImagePath方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">getImagePath</span><span class="hljs-params">(Uri uri, String selection)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> getContentResolver().query(uri, <span class="hljs-literal">null</span>, selection, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (cursor != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (cursor.moveToFirst()) &#123;<br>            path = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA));<br>        &#125;<br>        cursor.close();<br>    &#125;<br>    <span class="hljs-keyword">return</span> path;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们上面说过了getContentResolver是contentProvider中的内容的处理者，这里做一个查询。cursor是一个游标（数据库内容），它对应数据库中的一行。这里拿到先让游标移动到开头，接着getColumnIndexOrThrow传入MediaStore.Images.Media.DATA来获取path。之前这里方法用的是getColumnIndex一直会报错不能为负值，研究了半天发现改成getColumnIndexOrThrow就不追究这些了。cursor.close();记得关闭游标，否则会引发内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayImage</span><span class="hljs-params">(String imagePath)</span> &#123;<br>    <span class="hljs-keyword">if</span> (imagePath != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> BitmapFactory.decodeFile(imagePath);<br>        ivAvatar.setImageBitmap(bitmap);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">imageToBase64</span> <span class="hljs-operator">=</span> ImageUtil.imageToBase64(bitmap);<br>        imageBase64 = imageToBase64;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此方法用来展示图片。</p>
<p>在19后呢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TargetApi(19)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleImageOnApi19</span><span class="hljs-params">(Intent data)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">imagePath</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> data.getData();<br>    <span class="hljs-keyword">if</span> (DocumentsContract.isDocumentUri(<span class="hljs-built_in">this</span>, uri)) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">documentId</span> <span class="hljs-operator">=</span> DocumentsContract.getDocumentId(uri);<br><br>        <span class="hljs-keyword">if</span> (TextUtils.equals(uri.getAuthority(), <span class="hljs-string">&quot;com.android.providers.media.documents&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> documentId.split(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">String</span> <span class="hljs-variable">selection</span> <span class="hljs-operator">=</span> MediaStore.Images.Media._ID + <span class="hljs-string">&quot;=&quot;</span> + id;<br>            imagePath = getImagePath(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, selection);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TextUtils.equals(uri.getAuthority(), <span class="hljs-string">&quot;com.android.providers.downloads.documents&quot;</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (documentId != <span class="hljs-literal">null</span> &amp;&amp; documentId.startsWith(<span class="hljs-string">&quot;msf:&quot;</span>)) &#123;<br>                resolveMSFContent(uri, documentId);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-type">Uri</span> <span class="hljs-variable">contentUri</span> <span class="hljs-operator">=</span> ContentUris.withAppendedId(Uri.parse(<span class="hljs-string">&quot;content://downloads/public_downloads&quot;</span>), Long.valueOf(documentId));<br>            imagePath = getImagePath(contentUri, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;content&quot;</span>.equalsIgnoreCase(uri.getScheme())) &#123;<br>        imagePath = getImagePath(uri, <span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;file&quot;</span>.equalsIgnoreCase(uri.getScheme())) &#123;<br>        imagePath = uri.getPath();<br>    &#125;<br><br>    displayImage(imagePath);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此方法中先判断是否为document类型的uri，再细分为两类。第一类中媒体的图片内容我不是很理解，总之就是之后要用到的查询条件。</p>
<p>第二类下载的图片中就是直接获取了contentUri。还要对msf进行特殊处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveMSFContent</span><span class="hljs-params">(Uri uri, String documentId)</span> &#123;<br><br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getCacheDir(), <span class="hljs-string">&quot;temp_file&quot;</span> + getContentResolver().getType(uri).split(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">1</span>]);<br><span class="hljs-comment">//先生成一个文件</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> getContentResolver().openInputStream(uri);<br><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br><br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span> * <span class="hljs-number">1024</span>];<span class="hljs-comment">//缓冲区</span><br>        <span class="hljs-type">int</span> read;<br>        <span class="hljs-keyword">while</span> ((read = inputStream.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>            outputStream.write(buffer, <span class="hljs-number">0</span>, read);<br>        &#125;<br>        outputStream.flush();/清除<br><br>        <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> BitmapFactory.decodeFile(file.getAbsolutePath());<br>        ivAvatar.setImageBitmap(bitmap);<br>        imageBase64 = ImageUtil.imageToBase64(bitmap);<br><br>    &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>        e.printStackTrace();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>如果不是document类型的uri而是content类型就直接调用getImagePath。</p>
<p>如果是文件类型，直接uri.getPath()。</p>
<p>保存与初始化已在上一部分末尾给出。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>设置头像分为两大板块展开，一个是相机，另一个是相册。主要是先判断权限、申请权限，再调用相机&#x2F;获取图片文件，获得uri并转成bitmap显示，并通过转为base64放入sharedpreferences保存。</p>
<p>P.S.还有看到UCrop裁剪图片的，就是<del>jcenter()</del>用不了了，我试了别的方法想用UCrop但没弄明白怎么搞。</p>
<p>当然也可以自定义裁剪工具。</p>
<p>其实还学了一堆博客和垃圾？，方法有同有异的部分，就不方便总结了，总之为了搞明白设置头像人麻了，其实到今天才大概算是成功，还有六小时就组会了，就不画总结图了。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2022/10/24/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2/">← Next C语言字符串</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2022/10/18/MVP%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">MVP设计模式 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details></div><div id="bottom-btn"><a id="to-top" onClick="index.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><div class="aside-box"><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">粉蓝色の浅梦</a></h1><div id="description"><p></p></div><!--if page.published === undefined--><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">4</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">2</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">0</span></div></section></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%A4%B4%E5%83%8F%EF%BC%88%E5%AD%A6%E5%BA%9F%E4%BA%86%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">设置头像（学废了）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%9D%83%E9%99%90"><span class="toc-number">1.1.</span> <span class="toc-text">一、权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8A%A8%E6%80%81%E6%9D%83%E9%99%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.动态权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9D%99%E6%80%81%E6%9D%83%E9%99%90"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.静态权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BB%8E%E7%9B%B8%E6%9C%BA%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87"><span class="toc-number">1.2.</span> <span class="toc-text">二、从相机获取图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BB%8E%E7%9B%B8%E5%86%8C%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87"><span class="toc-number">1.3.</span> <span class="toc-text">三、从相册获取图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><br><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><br><text>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></text><text> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></text><wbr><text>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></text></footer></aside></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script>const reset=_=>{}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>document.addEventListener("load",reset())</script></body></html>